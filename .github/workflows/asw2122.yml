name: CI for ASW2122

on:
    release:
        types: [published]

jobs:
       
    docker-push-webapp:
        name: Push webapp Docker Image to GitHub Packages
        runs-on: ubuntu-latest
        env:
            API_URI: http://${{ secrets.DEPLOY_HOST }}:5000
        #       needs: [e2e-tests]
        steps:
            - uses: actions/checkout@v2
            - name: Publish to Registry
              uses: elgohr/Publish-Docker-Github-Action@3.04
              with:
                  name: arquisoft/dede_en2b/webapp
                  username: ${{ github.actor }}
                  password: ${{ secrets.DOCKER_PUSH_TOKEN }}
                  registry: ghcr.io
                  workdir: webapp
    docker-push-restapi:
        name: Push restapi Docker Image to GitHub Packages
        runs-on: ubuntu-latest
        #       needs: [e2e-tests]
        steps:
            - uses: actions/checkout@v2
            - name: Publish to Registry
              uses: elgohr/Publish-Docker-Github-Action@3.04
              with:
                  name: arquisoft/dede_en2b/restapi
                  username: ${{ github.actor }}
                  password: ${{ secrets.DOCKER_PUSH_TOKEN }}
                  registry: ghcr.io
                  workdir: restapi-springboot
    deploy:
        name: Deploy over SSH
        runs-on: ubuntu-latest
        needs: [docker-push-restapi, docker-push-webapp]
        steps:
            - name: Deploy over SSH
              uses: fifsky/ssh-action@master
              with:
                  host: ${{ secrets.DEPLOY_HOST }}
                  user: ${{ secrets.DEPLOY_USER }}
                  key: ${{ secrets.DEPLOY_KEY }}
                  #                 args: "-tt -vvv"
                  command: |
                      wget https://raw.githubusercontent.com/Arquisoft/dede_en2b/master/docker-compose-deploy.yml -O docker-compose.yml
                      docker-compose stop
                      docker-compose rm -f
                      docker-compose pull   
                      docker-compose up -d
