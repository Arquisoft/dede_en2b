name: CI for ASW2122

env:
  MYSQL_DATABASE: dede
  MYSQL_USER: test_user
  MYSQL_PASSWORD: password
  MYSQL_HOST: mysql-master
  NODE_ENV: test

on:
    release:
        types: [published]
    push:
        branches:
        - master


jobs:
    
    unit-test-webapp:
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: webapp
        steps:
            - uses: actions/checkout@v2
            - uses: actions/setup-node@v2
              with:
                  node-version: 16
            - run: npm ci
            - run: npm test
            - uses: codecov/codecov-action@v2
    unit-test-restapi:
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: restapi-springboot
        services:
            mysql-master:
                image: mysql:5.7
                ports:
                - 3306/tcp
                env:
                    MYSQL_DATABASE: ${{ env.MYSQL_DATABASE }}
                    MYSQL_USER: ${{ env.MYSQL_USER }}
                    MYSQL_PASSWORD: ${{ env.MYSQL_PASSWORD }}
                    MYSQL_ROOT_PASSWORD: ${{ env.MYSQL_PASSWORD }}
                options: >-
                    --name=mysql-master
                    --health-cmd="mysqladmin ping"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=3
        steps:
            - uses: actions/checkout@v2
            - uses: actions/setup-java@v2
              with:
                distribution: 'zulu'
                java-version: '11'
                cache: 'maven'
            - name: Build with Maven
              run: mvn -B package --file pom.xml -DMYSQL_HOST=${{ env.MYSQL_HOST }} -DMYSQL_USER=${{ env.MYSQL_USER }} -DMYSQL_PASSWORD=${{ env.MYSQL_PASSWORD }}
            - name: test with maven
              run: mvn -B test --file pom.xml
    e2e-tests:
        needs: [unit-test-webapp, unit-test-restapi]
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - uses: actions/setup-node@v2
              with:
                  node-version: 16
            - run: npm --prefix webapp install
            - run: npm --prefix webapp run build
            - run: npm --prefix webapp run test:e2e
    docker-push-webapp:
        name: Push webapp Docker Image to GitHub Packages
        runs-on: ubuntu-latest
        needs: [e2e-tests]
        env:
            API_URI: http://${{ secrets.DEPLOY_HOST }}:5000 
        steps:
            - uses: actions/checkout@v2
            - name: Publish to Registry
              uses: elgohr/Publish-Docker-Github-Action@3.04
              with:
                  name: arquisoft/dede_en2b/webapp
                  username: ${{ github.actor }}
                  password: ${{ secrets.DOCKER_PUSH_TOKEN }}
                  registry: ghcr.io
                  workdir: webapp
    docker-push-restapi:
        name: Push restapi Docker Image to GitHub Packages
        runs-on: ubuntu-latest
        needs: [e2e-tests]
        steps:
            - uses: actions/checkout@v2
            - name: Publish to Registry
              uses: elgohr/Publish-Docker-Github-Action@3.04
              with:
                  name: arquisoft/dede_en2b/restapi
                  username: ${{ github.actor }}
                  password: ${{ secrets.DOCKER_PUSH_TOKEN }}
                  registry: ghcr.io
                  workdir: restapi-springboot
    deploy:
        name: Deploy over SSH
        runs-on: ubuntu-latest
        needs: [docker-push-restapi, docker-push-webapp]
        steps:
            - name: Deploy over SSH
              uses: fifsky/ssh-action@master
              with:
                  host: ${{ secrets.DEPLOY_HOST }}
                  user: ${{ secrets.DEPLOY_USER }}
                  key: ${{ secrets.DEPLOY_KEY }}
                  #                 args: "-tt -vvv"
                  command: |
                      wget https://raw.githubusercontent.com/Arquisoft/dede_en2b/master/docker-compose-deploy.yml -O docker-compose.yml
                      docker-compose stop
                      docker-compose rm -f
                      docker-compose pull   
                      docker-compose up -d
